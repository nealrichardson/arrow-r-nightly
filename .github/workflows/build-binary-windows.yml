name: Build Windows binary packages

on:
  schedule:
    - cron: |
        0 22 * * *
  push:
    paths:
      - '.github/workflows/build-binary-windows.yml'
      - bintray-upload.sh
      - up-date-description.sh
  # On tag too?

jobs:
  windows:
    name: Windows R ${{ matrix.r_version }} RTools ${{ matrix.rtools }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        # TODO: test on rtools40
        rtools: [35]
        r_version: ["3.5"] #, "3.6", "devel"]
    steps:
      - name: Checkout arrow-r-nightly
        uses: actions/checkout@v2
      - uses: r-lib/actions/setup-r@master
        with:
          rtools-version: ${{ matrix.rtools }}
          r-version: ${{ matrix.r_version }}
      - name: Install R package dependencies
        shell: Rscript {0}
        run: |
          options(pkgType="win.binary")
          install.packages("remotes")
          remotes::install_deps("arrow/r", dependencies = TRUE)
      - name: Check/build
        shell: Rscript {0}
        run: |
          Sys.setenv(MAKEFLAGS = paste0("-j", parallel::detectCores()))
          install.packages("arrow",
            type = "source",
            repos = "https://dl.bintray.com/ursalabs/arrow-r",
            INSTALL_opts="--build"
          )
          library(arrow)
          read_parquet(system.file("v0.7.1.parquet", package = "arrow"))
        - name: Upload to bintray
          shell: bash
          run: source bintray-upload.sh
